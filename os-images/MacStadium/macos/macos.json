{
  "variables": {
    "artifactory_username": "{{ env `ARTIFACTORY_USERNAME` }}",
    "artifactory_password": "{{ env `ARTIFACTORY_PASSWORD` }}",
    "artifactory_url": "{{ env `ARTIFACTORY_URL` }}",
    "artifactory_apikey": "{{ env `ARTIFACTORY_APIKEY` }}",
    "box_timestamp_version": "{{ user `box_version` }}.{{timestamp}}",
    "box_final_name": "{{ user `box_name` }}-ci-{{ user `salt_branch` }}",
    "box_testing_name": "{{ user `box_name` }}-ci-staging-{{ user `salt_branch` }}"
  },
  "builders": [
    {
      "communicator": "ssh",
      "source_path": "{{ user `boxes_cache_dir` }}/{{ user `source_box_name` }}.box",
      "add_force": true,
      "provider": "parallels",
      "type": "vagrant"
    }
  ],
  "provisioners": [
    {
      "type": "shell",
      "expect_disconnect": true,
      "script": "os-images/MacStadium/files/setup-base.sh",
      "start_retry_timeout": "10000s",
      "environment_vars": [
        "ARTIFACTORY_USERNAME={{ user `artifactory_username` }}",
        "ARTIFACTORY_PASSWORD={{ user `artifactory_password` }}"
      ]
    },
    {
      "type": "shell-local",
      "script": "os-images/MacStadium/files/prep-macos.sh",
      "environment_vars": [
        "SALT_BRANCH={{ user `salt_branch` }}",
        "SALT_PR={{ user `salt_pr` }}",
        "DISTRO_SLUG={{ user `distro_slug` }}",
        "PY_VERSION=3"
      ]
    },
    {
      "type": "file",
      "generated": true,
      "source": ".tmp/{{ user `distro_slug` }}/{{ user `salt_branch` }}/minion",
      "destination": "/tmp/overrides.conf",
      "direction": "upload"
    },
    {
      "type": "shell",
      "inline": [
        "sudo mkdir -p /etc/salt/minion.d /srv",
        "sudo mv /tmp/overrides.conf /etc/salt/minion.d/"
      ]
    },
    {
      "type": "file",
      "source": "os-images/MacStadium/files/bootstrap-salt.sh",
      "destination": "/tmp/salt-bootstrap.sh",
      "direction": "upload"
    },
    {
      "type": "shell",
      "inline": [
        "sudo sh /tmp/salt-bootstrap.sh {{ user `bootstrap_args` }} stable {{ user `bootstrap_version` }}"
      ]
    },
    {
      "type": "salt-masterless",
      "local_state_tree": ".tmp/{{ user `distro_slug` }}/{{ user `salt_branch` }}/states",
      "local_pillar_roots": ".tmp/{{ user `distro_slug` }}/{{ user `salt_branch` }}/pillar",
      "custom_state": "noop-placeholder",
      "skip_bootstrap": true,
      "salt_bin_dir": "/opt/salt/bin"
    },
    {
      "type": "shell",
      "inline": [
        "sudo salt-call --local state.sls {{ user `state_name` }} --retcode-passthrough",
        "sudo rm -rf /srv/pillar/* /tmp/pillar"
      ],
      "environment_vars": [
        "PATH=/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:/opt/salt/bin:/usr/local/sbin"
      ]
    },
    {
      "type": "shell-local",
      "script": "os-images/MacStadium/files/prep-macos.sh",
      "environment_vars": [
        "SALT_BRANCH={{ user `salt_branch` }}",
        "SALT_PR={{ user `salt_pr` }}",
        "DISTRO_SLUG={{ user `distro_slug` }}",
        "PY_VERSION=2"
      ]
    },
    {
      "type": "file",
      "generated": true,
      "source": ".tmp/{{ user `distro_slug` }}/{{ user `salt_branch` }}/pillar",
      "destination": "/tmp/pillar",
      "direction": "upload"
    },
    {
      "type": "shell",
      "inline": [
        "sudo rm -rf /srv/pillar",
        "sudo mv /tmp/pillar /srv",
        "sudo salt-call --local state.sls {{ user `state_name` }} --retcode-passthrough",
        "sudo rm -rf /srv/pillar /srv/salt /tmp/salt /tmp/pillar"
      ],
      "environment_vars": [
        "PATH=/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:/opt/salt/bin:/usr/local/sbin"
      ],
      "pause_after": "5s"
    },
    {
      "type": "shell",
      "script": "os-images/MacStadium/files/cleanup.sh"
    }
  ],
  "post-processors": [
    {
      "type": "shell-local",
      "inline": [
        "jfrog rt upload --url={{ user `artifactory_url` }} --apikey={{ user `artifactory_apikey` }} output-vagrant/package.box 'vagrant-boxes/macos/{{ user `box_testing_name` }}.box;box_name={{ user `box_testing_name` }};box_provider=parallels;box_version={{ user `box_timestamp_version` }};promoted=false'"
      ],
      "environment_vars": [
        "JFROG_CLI_OFFER_CONFIG=false"
      ]
    },
    {
      "type": "manifest",
      "output": "{{ user `salt_branch`}}-manifest.json",
      "strip_path": true,
      "custom_data": {
        "box_name": "{{ user `box_final_name` }}",
        "box_name_testing": "{{ user `box_testing_name` }}",
        "box_version": "{{ user `box_timestamp_version` }}",
        "box_provider": "parallels",
        "box_artifactory_repo": "vagrant-boxes/macos",
        "box_url": "{{ user `artifactory_url` }}/api/vagrant/vagrant-boxes/macos/{{ user `box_final_name` }}",
        "box_versioned_url": "{{ user `artifactory_url` }}/api/vagrant/vagrant-boxes/macos/{{ user `box_final_name` }}?properties=box_version%2B={{ user `box_timestamp_version` }}",
        "box_testing_url": "{{ user `artifactory_url` }}/api/vagrant/vagrant-boxes/macos/{{ user `box_testing_name` }}",
        "box_testing_versioned_url": "{{ user `artifactory_url` }}/api/vagrant/vagrant-boxes/macos/{{ user `box_testing_name` }}?properties=box_version%2B={{ user `box_timestamp_version` }}"
      }
    }
  ]
}
